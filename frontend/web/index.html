<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <script src="https://code.jquery.com/jquery-3.3.1.min.js"integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>

        <link rel="stylesheet" href="css/foundation.css">
        <link rel="stylesheet" href="css/app.css">
    </head>
    <body>
        <div class="grid-container">
            <div class="grid-x grid-padding-x">
                <div class="large-12 cell">
                    <h1>UltraSonic Fork Lift</h1>
                </div>
            </div>
            <div class="grid-x grid-padding-x">
                <div class="large-12 cell">
                    <h2>Locations</h2>
                    <div id="list-locations">
                        loading...
                    </div>
                </div>
                <div class="large-12 cell">
                    <h2>Devices</h2>
                    <div id="list-devices">
                       No Devices
                    </div>
                </div>
                <div class="large-12 cell">
                    <select id="duration">
                        <option value="day">Today</option>
                        <option value="week">Week</option>
                        <option value="month">Month</option>
                        <option value="year">Year</option>
                    </select>
                    <div id="device">
                    </div>
                </div>
            </div>
        </div>

        <script type="text/javascript">
            // const API_URL = 'http://172.16.7.71:8080/';
            const API_URL = 'http://localhost:8080/';

            loadLocations = () => {
                load(
                    {"type":"ListLocations"}, 
                    (res) => {
                        $list = $('#list-locations').html('');
                        res.data.forEach(el => {
                            $(`<button>${el}</button>`)
                                .click( () => {
                                    loadForkLifts(el)
                                })
                                .appendTo($list)
                        })
                    }
                )
            }

            loadForkLifts = (location) => {
                load(
                    {"type":"ListDevices", "location": location}, 
                    (res) => {
                        $list = $('#list-devices').html('');
                        res.data.forEach(el => {
                            $(`<button>${el.name}</button>`)
                                .click( () => {
                                    loadForkLift(el.id)
                                })
                                .appendTo($list)
                        })
                    }
                )
            }

            loadForkLift = (lift) => {

                let today = new Date();

                switch($('#duration').val()) {
                    case 'day':
                        start = new Date();
                        end = new Date();
                        break;

                    case 'week':
                        start = new Date().getMonday();
                        end = start.addDays(6);
                        break;

                    case 'month':
                        start = new Date(today.getFullYear(), getMonth(), 1);
                        end   = new Date(today.getFullYear(), getMonth()+1, 0);
                        break;

                    case 'year':
                        start = new Date(today.getFullYear(), 1, 1);
                        end   = new Date(today.getFullYear()+1, 12, 31);
                        break;
                }

                start.setHours(0,0,0,0);
                end.setHours(23,59,59,0);

                load(
                    {
                        "type":"ListOverview", 
                        "devices": [lift], 
                        "start": start,
                        "end":   end
                    }, 
                    ({type, data}) => {
                        $('#device').html('')
                        data.forEach( ({id, name, location, loadedTime, emptyTime}) => {
                        totalTime = loadedTime+emptyTime;
                        $list = $('#device')
                            .append('<h2>' + location + ' - ' + name + '</h2>')
                            .append('<div class="bar-graph">\
                                <div class="bar-graph-loaded" style="width: ' + (loadedTime/totalTime*100) + '%; "></div>\
                                <div class="bar-graph-empty" style="width: ' + (emptyTime/totalTime*100) + '%; "></div>\
                                </div>');
                        })

                    }
                )
            }

            load = (data, success) => {
                $.ajax({
                    url: API_URL,
                    data: JSON.stringify(data),
                    type: "POST",
                    success: success
                });
            }


            loadLocations();
        </script>

        <script type="text/javascript">
            Date.prototype.getMonday = function() {
                var day = this.getDay();
                return this.addDays( - day + (day == 0 ? -6 : 1) );
            }

            Date.prototype.addDays = function(days) {
                return new Date(new Date(this).setDate(this.getDate() + days))
            }

        </script>
    </body>
</html>